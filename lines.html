<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Make Picks ‚Äì NFL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="style.css" rel="stylesheet" />
  <style>
    .grid { display: grid; gap: 16px; grid-template-columns: 1fr 360px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    .card { background:#fff; border-radius:14px; padding:16px; box-shadow:0 8px 20px rgba(0,0,0,.06); }
    .muted { color:#666; font-size:.9rem; }
    .game { border:1px solid #eee; border-radius:12px; padding:12px; margin-bottom:12px; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#f3f4f6; margin-right:6px; font-size:.85rem; }
    /* High-contrast buttons */
    button, .btn, .btn-primary, .bet-line {
      background-color: #f3f4f6;
      color: #000;
      border: 1px solid #cfcfcf;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
    }
    button:hover, .btn:hover, .btn-primary:hover, .bet-line:hover { background-color: #e5e7eb; }
    .btn-primary { background:#0ea5e9; color:#000; border-color:#0ea5e9; }
    .danger { color:#b91c1c; }
    .success { color:#065f46; }
    .warn { color:#92400e; }
    .hr { height:1px; background:#eee; margin:12px 0; }
    .betslip-item { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px dashed #eee; }
    .nowrap { white-space:nowrap; }
    .rules { background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:10px; margin-top:10px; }
    .errors { background:#fff7ed; border:1px solid #fed7aa; border-radius:12px; padding:10px; margin-top:10px; }

    /* Props UI */
    details.props { border:1px solid #eee; border-radius:10px; padding:8px; background:#fafafa; }
    details.props summary { cursor:pointer; list-style:none; user-select:none; }
    details.props summary::-webkit-details-marker { display:none; }
    .props-grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:8px; }
    @media (max-width:700px){ .props-grid { grid-template-columns:1fr; } }
    .prop-block { border:1px solid #e5e7eb; background:#fff; border-radius:10px; padding:10px; }
    .prop-title { font-weight:600; font-size:.9rem; margin-bottom:6px; color:#111; }
    .prop-buttons { display:flex; flex-wrap:wrap; gap:6px; }
    .prop-buttons .btn { line-height:1; }

    /* === Contrast & accessibility polish (drop these at the end of your <style>) === */
:root {
  --text: #111;
  --muted: #374151;
  --border: #d1d5db;
  --surface: #f8fafc;
  --surface-2: #eef2ff;
  --accent: #0ea5e9;
}

/* General text color inside cards/games */
.card, .game { color: var(--text); }

/* Player Props summary looks clickable and readable */
details.props { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; }
details.props summary {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  font-weight: 600;
  color: var(--text) !important;
  background: #f3f4f6;
  border: 1px solid var(--border);
  border-radius: 8px;
}
details.props summary::after {
  content: '‚ñæ';
  margin-left: auto;
  color: var(--muted);
  transition: transform .2s ease;
}
details.props[open] summary { background: var(--surface-2); }
details.props[open] summary::after { transform: rotate(180deg); }

/* Ensure all text inside props blocks is dark */
.prop-title { color: var(--text) !important; }
.prop-buttons .btn {
  background: #ffffff;
  color: #111 !important;          /* <-- force dark text */
  border: 1px solid var(--border);
}
.prop-buttons .btn:hover { background: #f1f5f9; }
.prop-buttons .btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

/* Make the muted text slightly darker for readability */
.muted { color: #4b5563; }

/* ‚ÄúFix these before submitting‚Äù box contrast */
#validationErrors {
  background: #fff7ed;
  border: 1px solid #fdba74;
  color: #111;                     /* <-- dark body text */
  border-radius: 12px;
}
#validationErrors .warn { color: #7c2d12; font-weight: 600; }
#validationErrors ul { margin: 6px 0 0 16px; }
#validationErrors li { margin: 4px 0; }

/* Visual lock for same-game: */
button[disabled], .btn[disabled] { 
  opacity: .5; 
  cursor: not-allowed; 
  pointer-events: none;
}


  </style>
</head>
<body>
  <div class="row" style="margin-bottom:16px">
    <div>
      <h1>NFL Lines</h1>
      <div id="context" class="muted">Loading league/week...</div>
    </div>
    <div class="row" style="gap:8px">
      <label for="weekSelect" class="muted">Week</label>
      <select id="weekSelect" class="btn" style="min-width:90px"></select>
      <a class="btn" id="backToLeague" href="#">‚Üê Back to League</a>
    </div>
  </div>
  

    <div class="grid">
      <!-- LEFT: GAMES -->
      <div class="card">
        <div class="row" style="margin-bottom:8px">
          <div>
            <strong>Market:</strong>
            <span class="pill">Moneyline</span>
            <span class="pill">Spread</span>
            <span class="pill">Total</span>
            <span class="pill">Player Props</span>
          </div>
          <div class="muted">Data from The Odds API</div>
        </div>
        <div id="odds-container">Loading NFL odds‚Ä¶</div>
      </div>

      <!-- RIGHT: BETSLIP -->
      <div class="card">
        <h3>Your Parlay</h3>
        <div id="betslip"></div>
        <div class="hr"></div>

        <div id="rules" class="rules muted">Loading league rules‚Ä¶</div>
        <div id="validationErrors" class="errors" style="display:none"></div>

        <div class="hr"></div>
        <div id="totals" class="row">
          <div class="muted">Combined Odds</div>
          <div><strong id="combinedDecimal">1.00</strong> <span class="muted">(<span id="combinedAmerican">-10000</span>)</span></div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="clearSlip" class="btn">Clear</button>
          <button id="submitParlay" class="btn btn-primary">Submit Parlay</button>
        </div>
        <div class="muted" style="margin-top:10px">Minimum legs/odds rules are enforced before submission.</div>
      </div>
    </div>
  

  <script>
    /* ---------- Debug helper ---------- */
    function showError(msg) {
      const box = document.getElementById('odds-container') || document.body;
      const div = document.createElement('div');
      div.style.background = '#fff7ed';
      div.style.border = '1px solid #fed7aa';
      div.style.borderRadius = '12px';
      div.style.padding = '10px';
      div.style.margin = '10px 0';
      div.style.color = '#92400e';
      div.textContent = '‚ö†Ô∏è ' + msg;
      box.prepend(div);
    }

    /* ---------- URL / context ---------- */
    const q = new URLSearchParams(location.search);
    const leagueId = q.get('leagueId');
    const week = Number(q.get('week') || 1);

    // build week select (1-18)
function buildWeekSelect(current) {
  const sel = document.getElementById('weekSelect');
  if (!sel) return;
  sel.innerHTML = '';
  for (let i = 1; i <= 18; i++) {
    const opt = document.createElement('option');
    opt.value = String(i);
    opt.textContent = `Week ${i}`;
    if (i === current) opt.selected = true;
    sel.appendChild(opt);
  }
  sel.addEventListener('change', () => {
    const w = sel.value;
    // keep leagueId in the URL and set new week
    const url = new URL(location.href);
    url.searchParams.set('week', w);
    if (leagueId) url.searchParams.set('leagueId', leagueId);
    location.href = url.toString();
  });
}


    /* ---------- Odds conversions ---------- */
    function toAmerican(decimal) {
      if (!decimal || decimal <= 1) return -10000;
      return decimal >= 2 ? Math.round((decimal - 1) * 100)
                          : Math.round(-100 / (decimal - 1));
    }
    function americanToDecimal(american) {
      const n = Number(american);
      if (!isFinite(n)) return 1;
      return n >= 0 ? 1 + n / 100 : 1 + 100 / Math.abs(n);
    }
    function fmtAmerican(n) { return n > 0 ? `+${n}` : `${n}`; }

    /* ---------- State ---------- */
    let slip = [];
    let leagueSettings = null;

    function renderSlip() {
      const el = document.getElementById('betslip');
      if (!el) { showError('Missing #betslip container'); return; }
      el.innerHTML = '';

      if (slip.length === 0) {
        el.innerHTML = '<div class="muted">No legs yet. Click a price to add a leg.</div>';
      } else {
        slip.forEach((leg, idx) => {
          const row = document.createElement('div');
          row.className = 'betslip-item';
          row.innerHTML = `
            <div>
              <div><strong>${leg.team}</strong> <span class="muted">(${leg.marketLabel}${leg.line !== undefined ? ' ' + leg.line : ''})</span></div>
              <div class="muted">${leg.book} ‚Ä¢ ${leg.side}</div>
            </div>
            <div class="nowrap"><strong>${fmtAmerican(leg.oddsAmerican)}</strong> <button class="btn" data-remove="${idx}" type="button">‚úï</button></div>
          `;
          el.appendChild(row);
        });
      }

      const combined = slip.reduce((acc, l) => acc * (l.priceDecimal || 1), 1);
      const cd = document.getElementById('combinedDecimal');
      const ca = document.getElementById('combinedAmerican');
      if (cd && ca) {
        cd.textContent = combined.toFixed(3);
        ca.textContent = fmtAmerican(toAmerican(combined));
      }

      el.querySelectorAll('[data-remove]').forEach(btn => {
  btn.addEventListener('click', e => {
    const i = Number(e.currentTarget.getAttribute('data-remove'));
    const removed = slip[i];
    slip.splice(i, 1);
    renderSlip();
    renderValidation();
    // If that was the only leg for the game, unlock its buttons
    if (removed?.gameId && !gameHasLeg(removed.gameId)) {
      toggleGameButtons(removed.gameId, false);
    }
  });
});

    }

    function renderValidation() {
      const box = document.getElementById('validationErrors');
      if (!box) return;
      if (!leagueSettings) { box.style.display = 'none'; box.innerHTML = ''; return; }

      const msgs = [];
      const { numLegs, minLegOdds, minTotalOdds } = leagueSettings;

      if (Number.isFinite(numLegs) && slip.length !== Number(numLegs)) {
        msgs.push(`Your parlay must have exactly ${numLegs} leg(s). You currently have ${slip.length}.`);
      }
      if (Number.isFinite(minLegOdds)) {
        const bad = slip.filter(l => Number(l.oddsAmerican) < Number(minLegOdds));
        if (bad.length) msgs.push(`At least one leg is below the minimum leg odds (${minLegOdds > 0 ? '+'+minLegOdds : minLegOdds}).`);
      }
      if (Number.isFinite(minTotalOdds)) {
        const combinedDecimal = slip.reduce((acc, l) => acc * (l.priceDecimal || 1), 1);
        const minTotalDecimal = americanToDecimal(Number(minTotalOdds));
        if (combinedDecimal < minTotalDecimal) {
          const combinedAm = toAmerican(combinedDecimal);
          msgs.push(`Your total parlay odds ${fmtAmerican(combinedAm)} are below the minimum required +${minTotalOdds}.`);
        }
      }
      // üö´ No same-game parlays: only one leg per gameId
{
  const ids = slip.map(l => l.gameId).filter(Boolean);
  const seen = new Set();
  let dupFound = false;
  for (const id of ids) {
    if (seen.has(id)) { dupFound = true; break; }
    seen.add(id);
  }
  if (dupFound) {
    msgs.push('Only one leg per game is allowed (no same-game parlays).');
  }
}


      if (msgs.length) {
        box.style.display = '';
        box.innerHTML = `<div class="warn"><strong>Fix these before submitting:</strong></div><ul style="margin:8px 0 0 16px">${msgs.map(e => `<li>${e}</li>`).join('')}</ul>`;
      } else {
        box.style.display = 'none';
        box.innerHTML = '';
      }
    }

    document.getElementById('clearSlip').addEventListener('click', () => {
      slip = [];
      renderSlip();
      renderValidation();
    });

    /* ---------- League rules ---------- */
    async function loadLeagueRules() {
      const rulesEl = document.getElementById('rules');
      try {
        const res = await fetch(`/league/${leagueId}`);
        const league = await res.json();
        if (!res.ok) throw new Error(league?.error || 'Failed to load league');

        leagueSettings = league.settings || {};
        const { numLegs, minLegOdds, minTotalOdds, leagueType } = leagueSettings;

        rulesEl.innerHTML = `
          <div><strong>Rules</strong></div>
          <div>Format: <strong>${leagueType}</strong></div>
          <div>Required legs: <strong>${numLegs}</strong></div>
          <div>Min leg odds: <strong>${minLegOdds > 0 ? '+' + minLegOdds : minLegOdds}</strong></div>
          <div>Min total parlay odds: <strong>+${minTotalOdds}</strong></div>
        `;
      } catch (e) {
        console.error('League rules error:', e);
        rulesEl.innerHTML = '<span class="warn">Could not load league rules. Submission will be blocked.</span>';
      }
    }

    /* ---------- Pretty labels & key aliases ---------- */
    function titleCase(s) { return s.replace(/\b(\w)/g, c => c.toUpperCase()); }
    function prettyKey(k) {
      return titleCase(
        k.replace(/^player_/, '')
         .replace(/_/g, ' ')
         .replace('Yds', 'Yds')
         .replace('Td', 'TD')
      );
    }
    // Show these markets if present (exact Odds API keys)
    const PROP_KEY_GROUPS = [
  ['player_pass_yds'],
  ['player_pass_tds'],        // NEW
  ['player_reception_yds'],
  ['player_receptions'],      // NEW
  ['player_rush_yds'],
  ['player_anytime_td']
];
const PROP_KEYS_FLAT = Array.from(new Set(PROP_KEY_GROUPS.flat()));



// --- No same-game parlays helpers ---
function gameHasLeg(gameId) {
  return slip.some(l => l.gameId === gameId);
}
function toggleGameButtons(gameId, disabled) {
  const gameDiv = document.querySelector(`.game[data-game-id="${gameId}"]`);
  if (!gameDiv) return;
  gameDiv.querySelectorAll('button.btn').forEach(btn => { btn.disabled = !!disabled; });
}




 /* ---------- helper to push a leg ---------- */
function pushLeg({ game, bookTitle, key, label, side, who, line, priceDecimal, matchup }) {
  if (!game?.id) { showError('Missing game id for selection.'); return; }
  if (gameHasLeg(game.id)) {
    alert('Only one leg per game is allowed. Remove the existing leg first.');
    return;
  }

  const am = toAmerican(priceDecimal);
  const builtMatchup = matchup || game.title || '';
  slip.push({
    gameId: game.id,
    market: key,
    marketLabel: label,
    side: side || who,
    team: who,
    line: (line !== '' && line !== undefined) ? Number(line) : undefined,
    priceDecimal,
    oddsAmerican: am,
    book: bookTitle,
    matchup: builtMatchup || null
  });

  // Lock this game's buttons
  toggleGameButtons(game.id, true);
  renderSlip();
  renderValidation();
}


    // Drop in smarter parsing for Over/Under vs. Yes/No
    function normalizeLabel(key) {
  const map = {
    player_pass_yds: 'Passing Yards',
    player_pass_tds: 'Passing TDs',        // NEW
    player_reception_yds: 'Reception Yards',
    player_receptions: 'Receptions',       // NEW
    player_rush_yds: 'Rushing Yards',
    player_anytime_td: 'Anytime TD Scorer'
  };
  return map[key] || prettyKey(key);
}


// Extract player name / side (Over|Under|Yes|No) / line / price robustly
function parseOutcome(marketKey, oc) {
  const name = (oc.name || '').toString();
  const desc = (oc.description || '').toString();
  const playerField = oc.player || oc.participant || '';

  const isOU = (s) => /^over|under$/i.test(s);
  const isYN = (s) => /^yes|no$/i.test(s);

  let playerName = '';
  let side = '';
  if (marketKey === 'player_anytime_td' || marketKey === 'player_1st_td') {
    // Usually one outcome per player ("Yes")
    playerName = (!isYN(name) && name) || playerField || desc || 'Player';
    side = (isYN(name) && name) || (isYN(desc) && desc) || 'Yes';
  } else {
    if (isOU(name)) { side = name; playerName = playerField || desc || 'Player'; }
    else if (isOU(desc)) { side = desc; playerName = name || playerField || 'Player'; }
    else { playerName = name || playerField || 'Player'; side = ''; }
  }

  const line = (oc.point !== undefined && oc.point !== null) ? oc.point : '';
  const price = Number(oc.price);
  return { playerName, side, line, price };
}

    /* ---------- Render a game ---------- */
    function renderGame(game, container) {
      const div = document.createElement('div');
      div.className = 'game';

      div.setAttribute('data-game-id', game.id || '');


      const home = game?.home_team || 'Home';
const away = game?.away_team || 'Away';
const commence = game?.commence_time ? new Date(game.commence_time).toLocaleString() : 'TBD';
const matchup = `${away} @ ${home}`;   // <-- add this


      div.innerHTML = `
        <div class="row">
          <div>
            <div><strong>${away}</strong> @ <strong>${home}</strong></div>
            <div class="muted">${commence}</div>
          </div>
          <div class="muted">Game ID: ${game.id || 'n/a'}</div>
        </div>
        <div class="hr"></div>
        <div class="markets"></div>
      `;

      const marketsEl = div.querySelector('.markets');

      // pick a bookmaker that actually has our props, else fallback to the first
      let book = null;
      if (Array.isArray(game.bookmakers) && game.bookmakers.length) {
        book =
          game.bookmakers.find(b =>
            Array.isArray(b.markets) &&
            b.markets.some(m => PROP_KEYS_FLAT.includes(m.key))
          ) || game.bookmakers[0];
      }
      if (!book || !Array.isArray(book.markets)) {
        marketsEl.innerHTML = '<div class="muted">No markets available for this game.</div>';
        container.appendChild(div);
        return;
      }

      // index markets by key
      const mIndex = {};
      book.markets.forEach(m => { mIndex[m.key] = m; });

      /* --- Core markets --- */
      // Moneyline (h2h)
      if (mIndex.h2h && Array.isArray(mIndex.h2h.outcomes)) {
        const ml = document.createElement('div');
        ml.innerHTML = `<div style="margin:6px 0"><strong>${book.title}</strong> ‚Ä¢ Moneyline</div>`;
        mIndex.h2h.outcomes.forEach(oc => {
          const price = Number(oc.price);
          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.type = 'button';
          btn.textContent = `${oc.name} ${fmtAmerican(toAmerican(price))}`;
          btn.addEventListener('click', () => {
            pushLeg({
              game, bookTitle: book.title, key: 'moneyline', label: 'Moneyline',
              side: oc.name, who: oc.name, line: undefined, priceDecimal: price
            });
          });
          ml.appendChild(btn);
        });
        marketsEl.appendChild(ml);
      }

      // Spread
      if (mIndex.spreads && Array.isArray(mIndex.spreads.outcomes)) {
        const sp = document.createElement('div');
        sp.innerHTML = `<div style="margin:6px 0"><strong>${book.title}</strong> ‚Ä¢ Spread</div>`;
        mIndex.spreads.outcomes.forEach(oc => {
          const price = Number(oc.price);
          const line = oc.point;
          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.type = 'button';
          btn.textContent = `${oc.name} ${line > 0 ? '+'+line : line} ${fmtAmerican(toAmerican(price))}`;
          btn.addEventListener('click', () => {
            pushLeg({
              game, bookTitle: book.title, key: 'spread', label: 'Spread',
              side: oc.name, who: oc.name, line, priceDecimal: price
            });
          });
          sp.appendChild(btn);
        });
        marketsEl.appendChild(sp);
      }

      // Totals
      if (mIndex.totals && Array.isArray(mIndex.totals.outcomes)) {
        const tot = document.createElement('div');
        tot.innerHTML = `<div style="margin:6px 0"><strong>${book.title}</strong> ‚Ä¢ Total</div>`;
        mIndex.totals.outcomes.forEach(oc => {
          const price = Number(oc.price);
          const line = oc.point;
          const label = oc.name?.toUpperCase() || 'TOTAL';
          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.type = 'button';
          btn.textContent = `${label} ${line} ${fmtAmerican(toAmerican(price))}`;
          btn.addEventListener('click', () => {
            pushLeg({
              game, bookTitle: book.title, key: 'total', label: 'Total',
              side: label, who: label, line, priceDecimal: price, matchup
            });
          });
          tot.appendChild(btn);
        });
        marketsEl.appendChild(tot);
      }

     /* --- Player Props (multi-market) --- */
const presentPropKeys = [];
PROP_KEY_GROUPS.forEach(group => {
  const found = group.find(k => mIndex[k]);
  if (found) presentPropKeys.push({ want: group[0], actual: found });
});

if (presentPropKeys.length) {
  const details = document.createElement('details');
  details.className = 'props';
  details.open = false;
  const summary = document.createElement('summary');
  summary.innerHTML = `<strong>Player Props</strong> <span class="muted">(tap to expand)</span>`;
  details.appendChild(summary);

  const grid = document.createElement('div');
  grid.className = 'props-grid';

  presentPropKeys.forEach(({ want, actual }) => {
    const market = mIndex[actual];
    if (!market || !Array.isArray(market.outcomes) || !market.outcomes.length) return;

    const label = normalizeLabel(want);
    const block = document.createElement('div');
    block.className = 'prop-block';
    const title = document.createElement('div');
    title.className = 'prop-title';
    title.textContent = label;
    block.appendChild(title);

    const btns = document.createElement('div');
    btns.className = 'prop-buttons';

    if (want === 'player_anytime_td' || want === 'player_1st_td') {
      // One button per player ("Yes" price)
      market.outcomes.forEach(oc => {
        const { playerName, side, line, price } = parseOutcome(want, oc);
        if (!Number.isFinite(price)) return;
        const am = toAmerican(price);
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.type = 'button';
        btn.textContent = `${playerName} ${fmtAmerican(am)}`;
        btn.addEventListener('click', () => pushLeg({
          game, bookTitle: book.title, key: want, label,
          side: side || 'Yes', who: playerName, line, priceDecimal: price
        }));
        btns.appendChild(btn);
      });
    } else {
      // Over/Under: group by player
      const byPlayer = {};
      market.outcomes.forEach(oc => {
        const r = parseOutcome(want, oc);
        if (!r.playerName) return;
        const key = r.playerName;
        byPlayer[key] = byPlayer[key] || { over: null, under: null, point: r.line };
        if (/over/i.test(r.side)) byPlayer[key].over = r;
        if (/under/i.test(r.side)) byPlayer[key].under = r;
        if (r.line !== '') byPlayer[key].point = r.line;
      });

      Object.entries(byPlayer).forEach(([player, v]) => {
        const point = (v.point !== '' && v.point !== undefined) ? `${v.point}` : '';
        const row = document.createElement('div');
        row.style.display = 'grid';
        row.style.gridTemplateColumns = '1fr 1fr 1fr';
        row.style.gap = '6px';
        row.style.alignItems = 'center';
        row.style.marginBottom = '6px';
        row.innerHTML = `<div class="text-sm font-medium">${player}${point ? ` <span class="muted">(${point})</span>` : ''}</div>`;

        const overBtn = document.createElement('button');
        overBtn.className = 'btn';
        overBtn.type = 'button';
        if (v.over && Number.isFinite(v.over.price)) {
          overBtn.textContent = `Over ${fmtAmerican(toAmerican(v.over.price))}`;
          overBtn.addEventListener('click', () => pushLeg({
            game, bookTitle: book.title, key: want, label,
            side: 'Over', who: player, line: v.point, priceDecimal: v.over.price
          }));
        } else {
          overBtn.disabled = true; overBtn.textContent = 'Over ‚Äî';
        }

        const underBtn = document.createElement('button');
        underBtn.className = 'btn';
        underBtn.type = 'button';
        if (v.under && Number.isFinite(v.under.price)) {
          underBtn.textContent = `Under ${fmtAmerican(toAmerican(v.under.price))}`;
          underBtn.addEventListener('click', () => pushLeg({
            game, bookTitle: book.title, key: want, label,
            side: 'Under', who: player, line: v.point, priceDecimal: v.under.price
          }));
        } else {
          underBtn.disabled = true; underBtn.textContent = 'Under ‚Äî';
        }

        row.appendChild(overBtn);
        row.appendChild(underBtn);
        btns.appendChild(row);
      });
    }

    block.appendChild(btns);
    grid.appendChild(block);
  });

  details.appendChild(grid);
  marketsEl.appendChild(details);
}
// If a leg for this game is already on the slip, keep its buttons disabled
if (gameHasLeg(game.id)) toggleGameButtons(game.id, true);


      container.appendChild(div);
    }

    /* ---------- Fetch NFL odds ---------- */
    async function loadNFL() {
  const container = document.getElementById('odds-container');
  if (!container) { showError('Missing #odds-container'); return; }
  try {
    const res = await fetch(
      '/api/odds?sport=americanfootball_nfl'
      + '&bookmakers=fanduel'
      + `&week=${encodeURIComponent(week)}`
      + '&sundayOnly=1'
      + '&includeProps=1'
      + '&regions=us&oddsFormat=decimal'
    );
console.debug('X-Props-Present:', res.headers.get('X-Props-Present'));


if (!res.ok) {
      const t = await res.text().catch(()=> '');
      showError(`Odds request failed (${res.status}). ${t || ''}`.trim());
      container.innerHTML = '<div class="danger">Failed to load NFL odds.</div>';
      return;
    }
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      container.innerHTML = '<div class="muted">No Sunday slate games found for this week.</div>';
      return;
    }

    container.innerHTML = '';
    data.forEach(game => renderGame(game, container));
  } catch (e) {
    console.error(e);
    showError('Unexpected error loading NFL odds (see console).');
    container.innerHTML = '<div class="danger">Failed to load NFL odds.</div>';
  }
}


    /* ---------- Submit (with validation) ---------- */
    function validateSlip() {
      if (!leagueSettings) return ['League rules not loaded. Please wait and try again.'];
      const errs = [];
      const { numLegs, minLegOdds, minTotalOdds } = leagueSettings;

      if (Number.isFinite(numLegs) && slip.length !== Number(numLegs)) {
        errs.push(`Your parlay must have exactly ${numLegs} leg(s). You currently have ${slip.length}.`);
      }
      if (Number.isFinite(minLegOdds)) {
        const bad = slip.filter(l => Number(l.oddsAmerican) < Number(minLegOdds));
        if (bad.length) errs.push(`At least one leg is below the minimum leg odds (${minLegOdds > 0 ? '+'+minLegOdds : minLegOdds}).`);
      }
      if (Number.isFinite(minTotalOdds)) {
        const combinedDecimal = slip.reduce((acc, l) => acc * (l.priceDecimal || 1), 1);
        const minTotalDecimal = americanToDecimal(Number(minTotalOdds));
        if (combinedDecimal < minTotalDecimal) {
          const combinedAm = toAmerican(combinedDecimal);
          errs.push(`Your total parlay odds ${fmtAmerican(combinedAm)} are below the minimum required +${minTotalOdds}.`);
        }
      }

      // üö´ No same-game parlays (server will reject too, but we block early)
{
  const ids = slip.map(l => l.gameId).filter(Boolean);
  const seen = new Set();
  for (const id of ids) {
    if (seen.has(id)) {
      errs.push('Only one leg per game is allowed (no same-game parlays).');
      break;
    }
    seen.add(id);
  }
}

      return errs;
    }

    async function submitParlay() {
      const token = localStorage.getItem('token');
      if (!token) { alert('Please log in to submit a parlay.'); return; }
      if (!leagueId || !week) { alert('Missing league or week.'); return; }
      if (slip.length === 0) { alert('Add at least one leg.'); return; }

      const errs = validateSlip();
      const errBox = document.getElementById('validationErrors');
      if (errs.length) {
        errBox.style.display = '';
        errBox.innerHTML = `<div class="warn"><strong>Fix these before submitting:</strong></div><ul style="margin:8px 0 0 16px">${errs.map(e => `<li>${e}</li>`).join('')}</ul>`;
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return;
      } else {
        errBox.style.display = 'none';
        errBox.innerHTML = '';
      }

      const picks = slip.map(l => ({
  team: l.team,               // team OR player name
  type: l.market,             // e.g. 'total', 'player_pass_yds'
  side: l.side ?? null,       // 'Over' | 'Under' | 'Yes' | etc.
  line: (l.line !== undefined && l.line !== null) ? Number(l.line) : null, // numeric line/yds
  odds: l.oddsAmerican,        // keep as American in picks
  matchup: l.matchup || null  // <-- carry game (e.g., "ATL @ GB")
}));


      const totalOdds = slip.reduce((acc, l) => acc * (l.priceDecimal || 1), 1);

      try {
  const res = await fetch('/api/parlay/submit', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify({ leagueId, week, picks, odds: Number(totalOdds.toFixed(4)) })
  });

  if (res.status === 401) {
    // token expired or invalid ‚Üí log out and go to login
    localStorage.removeItem('token');
    alert('Your session expired. Please log in again.');
    location.href = 'login.html';
    return;
  }

  const data = await res.json();

  if (!res.ok) {
    console.error('Submit error:', data);
    alert(data.error || 'Error submitting parlay.');
    return;
  }

  alert('Parlay submitted!');
  location.href = `league_home.html?leagueId=${encodeURIComponent(leagueId)}`;
} catch (err) {
  console.error(err);
  alert('Network/server error submitting parlay.');
}

    }

    document.getElementById('submitParlay').addEventListener('click', submitParlay);

    /* ---------- Init ---------- */
    async function init() {
      const contextEl = document.getElementById('context');
      const backBtn = document.getElementById('backToLeague');
      if (!leagueId) { alert('No leagueId provided. Returning to dashboard.'); location.href = 'dashboard.html'; return; }
      if (contextEl) contextEl.textContent = `League: ${leagueId} ‚Ä¢ Week: ${week} ‚Ä¢ Sunday slate`;
buildWeekSelect(week);

      if (backBtn) backBtn.href = `league_home.html?leagueId=${encodeURIComponent(leagueId)}`;

      await loadLeagueRules();
      await loadNFL();
      renderSlip();
      renderValidation();
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NFL Lines • Parlay Friends</title>
  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --muted:#6b7280;
      --ink:#111827;
      --brand:#10b981;
      --brand-ink:#065f46;
      --border:#e5e7eb;
      --zebra:#f9fafb;
      --chip:#111827;
      --chip-ink:#ffffff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--ink);
    }

    /* Header */
    .site-header{
      background:#fff;
      border-bottom:1px solid var(--border);
    }
    .bar{
      max-width:1100px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .logo{
      display:flex; align-items:center; gap:10px;
      font-weight:700; font-size:18px;
      color:var(--ink); text-decoration:none;
    }
    .crumbs{
      font-size:14px; color:var(--muted);
    }

    /* Layout */
    .wrap{
      max-width:1100px;
      margin:24px auto 48px;
      padding:0 16px;
    }

    .toolbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:16px;
    }
    .btn{
      appearance:none; border:1px solid var(--border);
      padding:10px 14px; border-radius:10px; background:#fff; cursor:pointer;
      font-weight:600;
    }
    .btn.secondary{ background:#fff; color:#111; }
    .btn.brand{ background:var(--brand); color:#fff; border-color:var(--brand); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    /* Cards */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding:14px 16px;
      border-bottom:1px solid var(--border);
      font-size:16px;
    }

    /* Tabs */
    .tabs{
      display:flex; gap:8px; padding:10px; border-bottom:1px solid var(--border);
      background: #fff;
    }
    .tab{
      border:1px solid var(--border);
      background:#fff; padding:8px 12px; border-radius:999px; cursor:pointer;
      font-size:14px; font-weight:600; color:#111;
    }
    .tab.active{ background:#111827; color:#fff; border-color:#111827; }

    /* Lines table */
    .table{
      width:100%; border-collapse:collapse;
    }
    .table thead th{
      text-align:left; font-size:12px; color:var(--muted); font-weight:700;
      padding:10px 12px; background:#fff; position:sticky; top:0; z-index:1;
      border-bottom:1px solid var(--border);
    }
    .row{
      display:grid;
      grid-template-columns: 1.6fr 0.9fr 0.9fr 0.9fr 1.2fr;
      gap:8px; align-items:center;
      padding:10px 12px; border-bottom:1px solid var(--border);
      background:#fff;
    }
    .row:nth-child(even){ background:var(--zebra); }
    .matchup{ display:flex; flex-direction:column; gap:6px; }
    .teams{ font-weight:700; }
    .time{ font-size:12px; color:var(--muted); }
    .cell{ display:flex; gap:8px; align-items:center; }

    .price{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 12px; min-width:78px;
      border:1px solid var(--border); border-radius:10px;
      background:#fff; cursor:pointer; font-weight:700;
      transition: transform .02s ease, box-shadow .12s ease;
    }
    .price:hover{ transform: translateY(-1px); box-shadow:0 2px 7px rgba(0,0,0,.06); }
    .price.selected{ background: var(--chip); color:var(--chip-ink); border-color:var(--chip); }

    .empty{
      padding:18px; color:var(--muted);
    }

    /* Make sure NOTHING invisible overlays the grid */
    #overlay, .popup, .modal, .backdrop{
      pointer-events:none !important; opacity:0 !important; display:none !important;
    }

    /* Responsive */
    @media (max-width:780px){
      .row{ grid-template-columns: 1.5fr 1fr 1fr; }
      .col-hide{ display:none; }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="bar">
      <a class="logo" href="index.html">
        <span>Parlay Friends</span>
      </a>
      <div class="crumbs">NFL • Lines</div>
    </div>
  </header>

  <main class="wrap">
    <div class="toolbar">
      <button id="backBtn" class="btn secondary">← Back to League Home</button>
      <div style="display:flex; gap:8px;">
        <button id="openParlay" class="btn brand">My Parlay</button>
      </div>
    </div>

    <div class="card">
      <div class="tabs" role="tablist" aria-label="Markets">
        <button class="tab active" data-market="h2h" aria-selected="true">Moneyline</button>
        <button class="tab" data-market="spreads">Spread</button>
        <button class="tab" data-market="totals">Total</button>
        <button class="tab" data-market="player_props">Player Props</button>
      </div>

      <h2 id="marketTitle">NFL • Moneyline</h2>

      <div id="grid">
        <div class="empty">Loading NFL lines…</div>
      </div>
    </div>
  </main>

  <script>
    // --- Utilities / URL context ---
    const params = new URLSearchParams(window.location.search);
    const leagueId = params.get('leagueId');

    const backBtn = document.getElementById('backBtn');
    backBtn.onclick = () => {
      const target = leagueId ? `league_home.html?leagueId=${encodeURIComponent(leagueId)}` : 'dashboard.html';
      window.location.href = target;
    };

    document.getElementById('openParlay').onclick = () => {
      const target = leagueId ? `my_parlay.html?leagueId=${encodeURIComponent(leagueId)}` : 'my_parlay.html';
      window.location.href = target;
    };

    // --- Tabs / markets ---
    const tabs = Array.from(document.querySelectorAll('.tab'));
    const grid = document.getElementById('grid');
    const title = document.getElementById('marketTitle');

    const MARKET_LABELS = {
      h2h: 'Moneyline',
      spreads: 'Spread',
      totals: 'Total',
      player_props: 'Player Props'
    };

    tabs.forEach(t => {
      t.addEventListener('click', () => {
        tabs.forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        const market = t.dataset.market;
        title.textContent = `NFL • ${MARKET_LABELS[market]}`;
        loadLines(market);
      });
    });

    // --- Fetch + Render ---
    async function loadLines(market = 'h2h'){
      try{
        grid.innerHTML = `<div class="empty">Loading ${MARKET_LABELS[market]}…</div>`;

        // Your server should honor the 'market' filter; if not, we filter client-side
        const res = await fetch(`/api/odds?sport=americanfootball_nfl${market ? `&market=${market}` : ''}`, {
          headers:{
            'Authorization':'Bearer ' + (localStorage.getItem('token') || '')
          }
        });
        if(!res.ok){
          throw new Error(`Failed to load odds (${res.status})`);
        }
        const data = await res.json();

        if(!Array.isArray(data) || data.length === 0){
          grid.innerHTML = `<div class="empty">No lines available.</div>`;
          return;
        }

        renderGrid(data, market);
      }catch(err){
        console.error(err);
        grid.innerHTML = `<div class="empty">Could not load lines. ${err.message}</div>`;
      }
    }

    function renderGrid(events, market){
      // Build header
      const header = `
        <div class="row" role="row" style="background:#fff; position:sticky; top:0; z-index:1;">
          <div class="cell" style="font-size:12px; color:#6b7280; font-weight:700;">Matchup</div>
          <div class="cell col-hide" style="font-size:12px; color:#6b7280; font-weight:700;">${MARKET_LABELS.h2h}</div>
          <div class="cell" style="font-size:12px; color:#6b7280; font-weight:700;">${MARKET_LABELS.spreads}</div>
          <div class="cell" style="font-size:12px; color:#6b7280; font-weight:700;">${MARKET_LABELS.totals}</div>
          <div class="cell" style="font-size:12px; color:#6b7280; font-weight:700;">Best Price</div>
        </div>
      `;

      const rows = events.map(ev => {
        const kickoff = ev.commence_time ? new Date(ev.commence_time) : null;
        const timeStr = kickoff ? kickoff.toLocaleString() : 'TBD';

        // Normalize market selections (these shapes may vary by feed)
        const best = pickBestPrices(ev, market);

        return `
          <div class="row" role="row">
            <div class="matchup">
              <div class="teams">${ev.away_team} @ ${ev.home_team}</div>
              <div class="time">${timeStr}</div>
            </div>

            <div class="cell col-hide">
              ${best.h2hHTML}
            </div>

            <div class="cell">
              ${best.spreadHTML}
            </div>

            <div class="cell">
              ${best.totalHTML}
            </div>

            <div class="cell">
              ${best.primaryHTML}
            </div>
          </div>
        `;
      }).join('');

      grid.innerHTML = header + rows;

      // Wire click handlers
      grid.querySelectorAll('button.price').forEach(btn => {
        btn.addEventListener('click', onPickClick);
      });
    }

    function pickBestPrices(ev, activeMarket){
      // Expecting structure from The Odds API proxy e.g., ev.bookmakers[].markets[]
      // This function is defensive: it searches by key names and falls back gracefully.
      const byKey = (name) => {
        const books = ev.bookmakers || [];
        let out = [];
        books.forEach(bk => {
          (bk.markets || []).forEach(m => {
            if((m.key || m.market) === name){
              (m.outcomes || []).forEach(o => out.push({book: bk.title || bk.key, ...o, market: name}));
            }
          });
        });
        return out;
      };

      const moneyline = byKey('h2h');
      const spreads   = byKey('spreads');
      const totals    = byKey('totals');

      const bestMLHome = bestByPrice(moneyline, o => o.name && /home|(\bhome\b)/i.test(o.name) ? 1 : (o.name === ev.home_team ? 1 : 0));
      const bestMLAway = bestByPrice(moneyline, o => o.name && /away|(\baway\b)/i.test(o.name) ? 1 : (o.name === ev.away_team ? 1 : 0));

      const bestSpread = spreads[0] || null; // Simplify: show a single best spread outcome (could expand)
      const bestTotal  = totals[0]  || null;

      const primary =
        activeMarket === 'h2h' ? (bestMLHome || bestMLAway) :
        activeMarket === 'spreads' ? bestSpread :
        activeMarket === 'totals' ? bestTotal : null;

      return {
        h2hHTML: [
          renderPriceBtn(bestMLAway, ev, 'h2h'),
          renderPriceBtn(bestMLHome, ev, 'h2h')
        ].join(''),

        spreadHTML: renderPriceBtn(bestSpread, ev, 'spreads'),
        totalHTML:  renderPriceBtn(bestTotal,  ev, 'totals'),
        primaryHTML: renderPriceBtn(primary, ev, activeMarket)
      };
    }

    function bestByPrice(list, predicate){
      // Try to pick a reasonable best; for simplicity, we’ll just take the first matching;
      // You can upgrade this to truly “best odds” selection later.
      return (list || []).find(() => true) || null;
    }

    function american(odds){
      if(odds === undefined || odds === null) return '';
      const n = Number(odds);
      if(Number.isNaN(n)) return String(odds);
      return n > 0 ? `+${n}` : `${n}`;
    }

    function renderPriceBtn(outcome, ev, marketKey){
      if(!outcome) return `<button class="price" disabled>—</button>`;
      const label =
        marketKey === 'spreads' ? `${outcome.point ?? ''} ${american(outcome.price ?? outcome.odds)}`
        : marketKey === 'totals' ? `${outcome.name ?? 'Total'} ${outcome.point ?? ''} ${american(outcome.price ?? outcome.odds)}`
        : `${outcome.name ?? ''} ${american(outcome.price ?? outcome.odds)}`;

      // Pack minimal payload in dataset
      const payload = {
        leagueId: leagueId || null,
        sport: 'NFL',
        market: marketKey,
        home: ev.home_team,
        away: ev.away_team,
        outcome: {
          name: outcome.name || '',
          point: outcome.point ?? null,
          price: outcome.price ?? outcome.odds ?? null,
          book: outcome.book || ''
        },
        eventId: ev.id || null,
        kickoff: ev.commence_time || null
      };

      const safe = encodeURIComponent(JSON.stringify(payload));
      return `<button class="price" data-payload="${safe}" type="button">${label}</button>`;
    }

    function onPickClick(e){
      const btn = e.currentTarget;
      const payload = JSON.parse(decodeURIComponent(btn.dataset.payload));

      // Save to localStorage
      const key = 'parlayItems';
      const current = JSON.parse(localStorage.getItem(key) || '[]');
      current.push(payload);
      localStorage.setItem(key, JSON.stringify(current));

      // Visual feedback
      btn.classList.add('selected');
      btn.blur();
    }

    // Initial load
    loadLines('h2h');
  </script>
</body>
</html>

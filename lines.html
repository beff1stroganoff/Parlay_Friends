<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Make Picks – NFL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="style.css" rel="stylesheet" />
  <style>
    .grid { display: grid; gap: 16px; grid-template-columns: 1fr 360px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    .card { background:#fff; border-radius:14px; padding:16px; box-shadow:0 8px 20px rgba(0,0,0,.06); }
    .muted { color:#666; font-size:.9rem; }
    .game { border:1px solid #eee; border-radius:12px; padding:12px; margin-bottom:12px; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#f3f4f6; margin-right:6px; font-size:.85rem; }
    /* High-contrast buttons */
    button, .btn, .btn-primary, .bet-line {
      background-color: #f3f4f6;
      color: #000;
      border: 1px solid #cfcfcf;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
    }
    button:hover, .btn:hover, .btn-primary:hover, .bet-line:hover { background-color: #e5e7eb; }
    .btn-primary { background:#0ea5e9; color:#000; border-color:#0ea5e9; }
    .danger { color:#b91c1c; }
    .success { color:#065f46; }
    .warn { color:#92400e; }
    .hr { height:1px; background:#eee; margin:12px 0; }
    .betslip-item { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px dashed #eee; }
    .nowrap { white-space:nowrap; }
    .rules { background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:10px; margin-top:10px; }
    .errors { background:#fff7ed; border:1px solid #fed7aa; border-radius:12px; padding:10px; margin-top:10px; }

    /* Props UI */
    details.props { border:1px solid #eee; border-radius:10px; padding:8px; background:#fafafa; }
    details.props summary { cursor:pointer; list-style:none; user-select:none; }
    details.props summary::-webkit-details-marker { display:none; }
    .props-grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:8px; }
    @media (max-width:700px){ .props-grid { grid-template-columns:1fr; } }
    .prop-block { border:1px solid #e5e7eb; background:#fff; border-radius:10px; padding:10px; }
    .prop-title { font-weight:600; font-size:.9rem; margin-bottom:6px; color:#111; }
    .prop-buttons { display:flex; flex-wrap:wrap; gap:6px; }
    .prop-buttons .btn { line-height:1; }
  </style>
</head>
<body>
  <div class="container" style="max-width:1200px; margin:32px auto; padding:0 16px;">
    <div class="row" style="margin-bottom:16px">
      <div>
        <h1>NFL Lines</h1>
        <div id="context" class="muted">Loading league/week...</div>
      </div>
      <div class="row">
        <a class="btn" id="backToLeague" href="#">← Back to League</a>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: GAMES -->
      <div class="card">
        <div class="row" style="margin-bottom:8px">
          <div>
            <strong>Market:</strong>
            <span class="pill">Moneyline</span>
            <span class="pill">Spread</span>
            <span class="pill">Total</span>
            <span class="pill">Player Props</span>
          </div>
          <div class="muted">Data from The Odds API</div>
        </div>
        <div id="odds-container">Loading NFL odds…</div>
      </div>

      <!-- RIGHT: BETSLIP -->
      <div class="card">
        <h3>Your Parlay</h3>
        <div id="betslip"></div>
        <div class="hr"></div>

        <div id="rules" class="rules muted">Loading league rules…</div>
        <div id="validationErrors" class="errors" style="display:none"></div>

        <div class="hr"></div>
        <div id="totals" class="row">
          <div class="muted">Combined Odds</div>
          <div><strong id="combinedDecimal">1.00</strong> <span class="muted">(<span id="combinedAmerican">-10000</span>)</span></div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="clearSlip" class="btn">Clear</button>
          <button id="submitParlay" class="btn btn-primary">Submit Parlay</button>
        </div>
        <div class="muted" style="margin-top:10px">Minimum legs/odds rules are enforced before submission.</div>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Debug helper ---------- */
    function showError(msg) {
      const box = document.getElementById('odds-container') || document.body;
      const div = document.createElement('div');
      div.style.background = '#fff7ed';
      div.style.border = '1px solid #fed7aa';
      div.style.borderRadius = '12px';
      div.style.padding = '10px';
      div.style.margin = '10px 0';
      div.style.color = '#92400e';
      div.textContent = '⚠️ ' + msg;
      box.prepend(div);
    }

    /* ---------- URL / context ---------- */
    const q = new URLSearchParams(location.search);
    const leagueId = q.get('leagueId');
    const week = Number(q.get('week') || 1);

    /* ---------- Odds conversions ---------- */
    function toAmerican(decimal) {
      if (!decimal || decimal <= 1) return -10000;
      return decimal >= 2 ? Math.round((decimal - 1) * 100)
                          : Math.round(-100 / (decimal - 1));
    }
    function americanToDecimal(american) {
      const n = Number(american);
      if (!isFinite(n)) return 1;
      return n >= 0 ? 1 + n / 100 : 1 + 100 / Math.abs(n);
    }
    function fmtAmerican(n) { return n > 0 ? `+${n}` : `${n}`; }

    /* ---------- State ---------- */
    let slip = [];
    let leagueSettings = null;

    function renderSlip() {
      const el = document.getElementById('betslip');
      if (!el) { showError('Missing #betslip container'); return; }
      el.innerHTML = '';

      if (slip.length === 0) {
        el.innerHTML = '<div class="muted">No legs yet. Click a price to add a leg.</div>';
      } else {
        slip.forEach((leg, idx) => {
          const row = document.createElement('div');
          row.className = 'betslip-item';
          row.innerHTML = `
            <div>
              <div><strong>${leg.team}</strong> <span class="muted">(${leg.marketLabel}${leg.line !== undefined ? ' ' + leg.line : ''})</span></div>
              <div class="muted">${leg.book} • ${leg.side}</div>
            </div>
            <div class="nowrap"><strong>${fmtAmerican(leg.oddsAmerican)}</strong> <button class="btn" data-remove="${idx}" type="button">✕</button></div>
          `;
          el.appendChild(row);
        });
      }

      const combined = slip.reduce((acc, l) => acc * (l.priceDecimal || 1), 1);
      const cd = document.getElementById('combinedDecimal');
      const ca = document.getElementById('combinedAmerican');
      if (cd && ca) {
        cd.textContent = combined.toFixed(3);
        ca.textContent = fmtAmerican(toAmerican(combined));
      }

      el.querySelectorAll('[data-remove]').forEach(btn => {
        btn.addEventListener('click', e => {
          const i = Number(e.currentTarget.getAttribute('data-remove'));
          slip.splice(i, 1);
          renderSlip();
          renderValidation();
        });
      });
    }

    function renderValidation() {
      const box = document.getElementById('validationErrors');
      if (!box) return;
      if (!leagueSettings) { box.style.display = 'none'; box.innerHTML = ''; return; }

      const msgs = [];
      const { numLegs, minLegOdds, minTotalOdds } = leagueSettings;

      if (Number.isFinite(numLegs) && slip.length !== Number(numLegs)) {
        msgs.push(`Your parlay must have exactly ${numLegs} leg(s). You currently have ${slip.length}.`);
      }
      if (Number.isFinite(minLegOdds)) {
        const bad = slip.filter(l => Number(l.oddsAmerican) < Number(minLegOdds));
        if (bad.length) msgs.push(`At least one leg is below the minimum leg odds (${minLegOdds > 0 ? '+'+minLegOdds : minLegOdds}).`);
      }
      if (Number.isFinite(minTotalOdds)) {
        const combinedDecimal = slip.reduce((acc, l) => acc * (l.priceDecimal || 1), 1);
        const minTotalDecimal = americanToDecimal(Number(minTotalOdds));
        if (combinedDecimal < minTotalDecimal) {
          const combinedAm = toAmerican(combinedDecimal);
          msgs.push(`Your total parlay odds ${fmtAmerican(combinedAm)} are below the minimum required +${minTotalOdds}.`);
        }
      }

      if (msgs.length) {
        box.style.display = '';
        box.innerHTML = `<div class="warn"><strong>Fix these before submitting:</strong></div><ul style="margin:8px 0 0 16px">${msgs.map(e => `<li>${e}</li>`).join('')}</ul>`;
      } else {
        box.style.display = 'none';
        box.innerHTML = '';
      }
    }

    document.getElementById('clearSlip').addEventListener('click', () => {
      slip = [];
      renderSlip();
      renderValidation();
    });

    /* ---------- League rules ---------- */
    async function loadLeagueRules() {
      const rulesEl = document.getElementById('rules');
      try {
        const res = await fetch(`/league/${leagueId}`);
        const league = await res.json();
        if (!res.ok) throw new Error(league?.error || 'Failed to load league');

        leagueSettings = league.settings || {};
        const { numLegs, minLegOdds, minTotalOdds, leagueType } = leagueSettings;

        rulesEl.innerHTML = `
          <div><strong>Rules</strong></div>
          <div>Format: <strong>${leagueType}</strong></div>
          <div>Required legs: <strong>${numLegs}</strong></div>
          <div>Min leg odds: <strong>${minLegOdds > 0 ? '+' + minLegOdds : minLegOdds}</strong></div>
          <div>Min total parlay odds: <strong>+${minTotalOdds}</strong></div>
        `;
      } catch (e) {
        console.error('League rules error:', e);
        rulesEl.innerHTML = '<span class="warn">Could not load league rules. Submission will be blocked.</span>';
      }
    }

    /* ---------- Pretty labels & key aliases ---------- */
    function titleCase(s) { return s.replace(/\b(\w)/g, c => c.toUpperCase()); }
    function prettyKey(k) {
      return titleCase(
        k.replace(/^player_/, '')
         .replace(/_/g, ' ')
         .replace('Yds', 'Yds')
         .replace('Td', 'TD')
      );
    }
    // Replace your PROP_KEY_GROUPS + PROP_KEYS_FLAT with this:
const PROP_KEY_GROUPS = [
  ['player_pass_yds']   // TEMP: only passing yards while we verify end-to-end
];
const PROP_KEYS_FLAT = Array.from(new Set(PROP_KEY_GROUPS.flat()));


    /* ---------- helper to push a leg ---------- */
    function pushLeg({game, bookTitle, key, label, side, who, line, priceDecimal}) {
      const am = toAmerican(priceDecimal);
      slip.push({
        gameId: game.id,
        market: key,
        marketLabel: label,
        side: side || who,
        team: who,
        line: (line !== '' && line !== undefined) ? Number(line) : undefined,
        priceDecimal,
        oddsAmerican: am,
        book: bookTitle
      });
      renderSlip();
      renderValidation();
    }

    /* ---------- Render a game ---------- */
    function renderGame(game, container) {
      const div = document.createElement('div');
      div.className = 'game';

      const home = game?.home_team || 'Home';
      const away = game?.away_team || 'Away';
      const commence = game?.commence_time ? new Date(game.commence_time).toLocaleString() : 'TBD';

      div.innerHTML = `
        <div class="row">
          <div>
            <div><strong>${away}</strong> @ <strong>${home}</strong></div>
            <div class="muted">${commence}</div>
          </div>
          <div class="muted">Game ID: ${game.id || 'n/a'}</div>
        </div>
        <div class="hr"></div>
        <div class="markets"></div>
      `;

      const marketsEl = div.querySelector('.markets');

      // pick a bookmaker that actually has our props, else fallback to the first
      let book = null;
      if (Array.isArray(game.bookmakers) && game.bookmakers.length) {
        book =
          game.bookmakers.find(b =>
            Array.isArray(b.markets) &&
            b.markets.some(m => PROP_KEYS_FLAT.includes(m.key))
          ) || game.bookmakers[0];
      }
      if (!book || !Array.isArray(book.markets)) {
        marketsEl.innerHTML = '<div class="muted">No markets available for this game.</div>';
        container.appendChild(div);
        return;
      }

      // index markets by key
      const mIndex = {};
      book.markets.forEach(m => { mIndex[m.key] = m; });

      /* --- Core markets --- */
      // Moneyline (h2h)
      if (mIndex.h2h && Array.isArray(mIndex.h2h.outcomes)) {
        const ml = document.createElement('div');
        ml.innerHTML = `<div style="margin:6px 0"><strong>${book.title}</strong> • Moneyline</div>`;
        mIndex.h2h.outcomes.forEach(oc => {
          const price = Number(oc.price);
          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.type = 'button';
          btn.textContent = `${oc.name} ${fmtAmerican(toAmerican(price))}`;
          btn.addEventListener('click', () => {
            pushLeg({
              game, bookTitle: book.title, key: 'moneyline', label: 'Moneyline',
              side: oc.name, who: oc.name, line: undefined, priceDecimal: price
            });
          });
          ml.appendChild(btn);
        });
        marketsEl.appendChild(ml);
      }

      // Spread
      if (mIndex.spreads && Array.isArray(mIndex.spreads.outcomes)) {
        const sp = document.createElement('div');
        sp.innerHTML = `<div style="margin:6px 0"><strong>${book.title}</strong> • Spread</div>`;
        mIndex.spreads.outcomes.forEach(oc => {
          const price = Number(oc.price);
          const line = oc.point;
          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.type = 'button';
          btn.textContent = `${oc.name} ${line > 0 ? '+'+line : line} ${fmtAmerican(toAmerican(price))}`;
          btn.addEventListener('click', () => {
            pushLeg({
              game, bookTitle: book.title, key: 'spread', label: 'Spread',
              side: oc.name, who: oc.name, line, priceDecimal: price
            });
          });
          sp.appendChild(btn);
        });
        marketsEl.appendChild(sp);
      }

      // Totals
      if (mIndex.totals && Array.isArray(mIndex.totals.outcomes)) {
        const tot = document.createElement('div');
        tot.innerHTML = `<div style="margin:6px 0"><strong>${book.title}</strong> • Total</div>`;
        mIndex.totals.outcomes.forEach(oc => {
          const price = Number(oc.price);
          const line = oc.point;
          const label = oc.name?.toUpperCase() || 'TOTAL';
          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.type = 'button';
          btn.textContent = `${label} ${line} ${fmtAmerican(toAmerican(price))}`;
          btn.addEventListener('click', () => {
            pushLeg({
              game, bookTitle: book.title, key: 'total', label: 'Total',
              side: label, who: label, line, priceDecimal: price
            });
          });
          tot.appendChild(btn);
        });
        marketsEl.appendChild(tot);
      }

      /* --- Player Props (your exact list, with key aliases) --- */
      const presentPropKeys = [];
      PROP_KEY_GROUPS.forEach(group => {
        const found = group.find(k => mIndex[k]);
        if (found) presentPropKeys.push({ want: group[0], actual: found });
      });

      if (presentPropKeys.length) {
        const details = document.createElement('details');
        details.className = 'props';
        details.open = false;
        const summary = document.createElement('summary');
        summary.innerHTML = `<strong>Player Props</strong> <span class="muted">(tap to expand)</span>`;
        details.appendChild(summary);

        const grid = document.createElement('div');
        grid.className = 'props-grid';

        presentPropKeys.forEach(({want, actual}) => {
          const market = mIndex[actual];
          if (!market || !Array.isArray(market.outcomes) || !market.outcomes.length) return;

          const block = document.createElement('div');
          block.className = 'prop-block';

          const label = prettyKey(want);
          const title = document.createElement('div');
          title.className = 'prop-title';
          title.textContent = label;
          block.appendChild(title);

          const btns = document.createElement('div');
          btns.className = 'prop-buttons';

          market.outcomes.forEach(oc => {
            const price = Number(oc.price);
            if (!Number.isFinite(price)) return;

            const who = oc.description || oc.participant || oc.player || oc.name || 'Player';
            const nameUpper = String(oc.name || '').toUpperCase();
            const side =
              nameUpper.includes('OVER')  ? 'Over'  :
              nameUpper.includes('UNDER') ? 'Under' :
              (want.includes('anytime_td') || want.includes('1st_td')) ? '' : oc.name || '';
            const line = (oc.point !== undefined && oc.point !== null) ? oc.point : '';

            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.type = 'button';
            const am = toAmerican(price);
            btn.textContent = [who, side || '', (line !== '' ? line : ''), fmtAmerican(am)]
              .join(' ').replace(/\s+/g,' ').trim();

            btn.addEventListener('click', () => {
              pushLeg({
                game, bookTitle: book.title,
                key: actual,
                label,
                side: side || who,
                who, line,
                priceDecimal: price
              });
            });

            btns.appendChild(btn);
          });

          block.appendChild(btns);
          grid.appendChild(block);
        });

        details.appendChild(grid);
        marketsEl.appendChild(details);
      }

      container.appendChild(div);
    }

    /* ---------- Fetch NFL odds ---------- */
    async function loadNFL() {
      const container = document.getElementById('odds-container');
      if (!container) { showError('Missing #odds-container'); return; }
      try {
        const res = await fetch('/api/odds?sport=americanfootball_nfl');
        if (!res.ok) {
          const t = await res.text().catch(()=> '');
          showError(`Odds request failed (${res.status}). ${t || ''}`.trim());
          container.innerHTML = '<div class="danger">Failed to load NFL odds.</div>';
          return;
        }
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = '<div class="muted">No NFL odds available.</div>';
          return;
        }

        container.innerHTML = '';
        data.forEach(game => renderGame(game, container));
      } catch (e) {
        console.error(e);
        showError('Unexpected error loading NFL odds (see console).');
        container.innerHTML = '<div class="danger">Failed to load NFL odds.</div>';
      }
    }

    /* ---------- Submit (with validation) ---------- */
    function validateSlip() {
      if (!leagueSettings) return ['League rules not loaded. Please wait and try again.'];
      const errs = [];
      const { numLegs, minLegOdds, minTotalOdds } = leagueSettings;

      if (Number.isFinite(numLegs) && slip.length !== Number(numLegs)) {
        errs.push(`Your parlay must have exactly ${numLegs} leg(s). You currently have ${slip.length}.`);
      }
      if (Number.isFinite(minLegOdds)) {
        const bad = slip.filter(l => Number(l.oddsAmerican) < Number(minLegOdds));
        if (bad.length) errs.push(`At least one leg is below the minimum leg odds (${minLegOdds > 0 ? '+'+minLegOdds : minLegOdds}).`);
      }
      if (Number.isFinite(minTotalOdds)) {
        const combinedDecimal = slip.reduce((acc, l) => acc * (l.priceDecimal || 1), 1);
        const minTotalDecimal = americanToDecimal(Number(minTotalOdds));
        if (combinedDecimal < minTotalDecimal) {
          const combinedAm = toAmerican(combinedDecimal);
          errs.push(`Your total parlay odds ${fmtAmerican(combinedAm)} are below the minimum required +${minTotalOdds}.`);
        }
      }
      return errs;
    }

    async function submitParlay() {
      const token = localStorage.getItem('token');
      if (!token) { alert('Please log in to submit a parlay.'); return; }
      if (!leagueId || !week) { alert('Missing league or week.'); return; }
      if (slip.length === 0) { alert('Add at least one leg.'); return; }

      const errs = validateSlip();
      const errBox = document.getElementById('validationErrors');
      if (errs.length) {
        errBox.style.display = '';
        errBox.innerHTML = `<div class="warn"><strong>Fix these before submitting:</strong></div><ul style="margin:8px 0 0 16px">${errs.map(e => `<li>${e}</li>`).join('')}</ul>`;
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return;
      } else {
        errBox.style.display = 'none';
        errBox.innerHTML = '';
      }

      const picks = slip.map(l => ({ team: l.team, type: l.market, odds: l.oddsAmerican }));
      const totalOdds = slip.reduce((acc, l) => acc * (l.priceDecimal || 1), 1);

      try {
        const res = await fetch('/api/parlay/submit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ leagueId, week, picks, odds: Number(totalOdds.toFixed(4)) })
        });
        const data = await res.json();
        if (!res.ok) {
          console.error('Submit error:', data);
          alert(data.error || 'Error submitting parlay.');
          return;
        }
        alert('Parlay submitted!');
        location.href = `league_home.html?leagueId=${encodeURIComponent(leagueId)}`;
      } catch (err) {
        console.error(err);
        alert('Network/server error submitting parlay.');
      }
    }

    document.getElementById('submitParlay').addEventListener('click', submitParlay);

    /* ---------- Init ---------- */
    async function init() {
      const contextEl = document.getElementById('context');
      const backBtn = document.getElementById('backToLeague');
      if (!leagueId) { alert('No leagueId provided. Returning to dashboard.'); location.href = 'dashboard.html'; return; }
      if (contextEl) contextEl.textContent = `League: ${leagueId} • Week: ${week}`;
      if (backBtn) backBtn.href = `league_home.html?leagueId=${encodeURIComponent(leagueId)}`;

      await loadLeagueRules();
      await loadNFL();
      renderSlip();
      renderValidation();
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Make Picks – NFL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="style.css" rel="stylesheet" />
  <style>
    .grid { display: grid; gap: 16px; grid-template-columns: 1fr 360px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    .card { background:#fff; border-radius:14px; padding:16px; box-shadow:0 8px 20px rgba(0,0,0,.06); }
    .muted { color:#666; font-size:.9rem; }
    .game { border:1px solid #eee; border-radius:12px; padding:12px; margin-bottom:12px; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#f3f4f6; margin-right:6px; font-size:.85rem; }
    .btn { border:1px solid #ddd; padding:8px 10px; border-radius:10px; background:#fafafa; cursor:pointer; }
    .btn:hover { background:#f0f0f0; }
    .btn-primary { background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
    .btn-primary:hover { filter:brightness(.95); }
    .danger { color:#b91c1c; }
    .success { color:#065f46; }
    .warn { color:#92400e; }
    .hr { height:1px; background:#eee; margin:12px 0; }
    .betslip-item { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px dashed #eee; }
    .nowrap { white-space:nowrap; }
    .rules { background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:10px; margin-top:10px; }
    .errors { background:#fff7ed; border:1px solid #fed7aa; border-radius:12px; padding:10px; margin-top:10px; }
  </style>
</head>
<body>
  <div class="container" style="max-width:1200px; margin:32px auto; padding:0 16px;">
    <div class="row" style="margin-bottom:16px">
      <div>
        <h1>NFL Lines</h1>
        <div id="context" class="muted">Loading league/week...</div>
      </div>
      <div class="row">
        <a class="btn" id="backToLeague" href="#">← Back to League</a>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: GAMES -->
      <div class="card">
        <div class="row" style="margin-bottom:8px">
          <div>
            <strong>Market:</strong>
            <span class="pill">Moneyline</span>
            <span class="pill">Spread</span>
            <span class="pill">Total</span>
            <span class="pill">Player Props (when available)</span>
          </div>
          <div class="muted">Data from The Odds API</div>
        </div>
        <div id="odds-container">Loading NFL odds…</div>
      </div>

      <!-- RIGHT: BETSLIP -->
      <div class="card">
        <h3>Your Parlay</h3>
        <div id="betslip"></div>
        <div class="hr"></div>

        <!-- live rules pulled from league -->
        <div id="rules" class="rules muted">Loading league rules…</div>

        <!-- validation messages appear here -->
        <div id="validationErrors" class="errors" style="display:none"></div>

        <div class="hr"></div>
        <div id="totals" class="row">
          <div class="muted">Combined Odds</div>
          <div><strong id="combinedDecimal">1.00</strong> <span class="muted">(<span id="combinedAmerican">-10000</span>)</span></div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="clearSlip" class="btn">Clear</button>
          <button id="submitParlay" class="btn btn-primary">Submit Parlay</button>
        </div>
        <div class="muted" style="margin-top:10px">Minimum legs/odds rules are enforced before submission.</div>
      </div>
    </div>
  </div>

  <script>
    // ===== URL / CONTEXT =====
    const q = new URLSearchParams(location.search);
    const leagueId = q.get('leagueId');
    const week = Number(q.get('week') || 1);

    const contextEl = document.getElementById('context');
    const backBtn = document.getElementById('backToLeague');
    if (!leagueId) {
      alert('No leagueId provided. Returning to dashboard.');
      location.href = 'dashboard.html';
    } else {
      contextEl.textContent = `League: ${leagueId} • Week: ${week}`;
      backBtn.href = `league_home.html?leagueId=${encodeURIComponent(leagueId)}`;
    }

    // ===== UTILS =====
    function toAmerican(decimal) {
      if (!decimal || decimal <= 1) return -10000;
      return decimal >= 2
        ? Math.round((decimal - 1) * 100)
        : Math.round(-100 / (decimal - 1));
    }
    function americanToDecimal(american) {
      const n = Number(american);
      if (!isFinite(n)) return 1;
      return n >= 0 ? 1 + n / 100 : 1 + 100 / Math.abs(n);
    }
    function fmtAmerican(n) { return n > 0 ? `+${n}` : `${n}`; }

    // ===== STATE =====
    let slip = []; // [{gameId, market, side, team, line, priceDecimal, oddsAmerican, book}]
    let leagueSettings = null; // { numLegs, minLegOdds, minTotalOdds, ... }

    function renderSlip() {
      const el = document.getElementById('betslip');
      el.innerHTML = '';

      if (slip.length === 0) {
        el.innerHTML = '<div class="muted">No legs yet. Click a price to add a leg.</div>';
      } else {
        slip.forEach((leg, idx) => {
          const row = document.createElement('div');
          row.className = 'betslip-item';
          row.innerHTML = `
            <div>
              <div><strong>${leg.team}</strong> <span class="muted">(${leg.market}${leg.line !== undefined ? ' ' + leg.line : ''})</span></div>
              <div class="muted">${leg.book} • ${leg.side}</div>
            </div>
            <div class="nowrap"><strong>${fmtAmerican(leg.oddsAmerican)}</strong> <button class="btn" data-remove="${idx}">✕</button></div>
          `;
          el.appendChild(row);
        });
      }

      // compute combined decimal odds
      const combined = slip.reduce((acc, l) => acc * (l.priceDecimal || 1), 1);
      document.getElementById('combinedDecimal').textContent = combined.toFixed(3);
      document.getElementById('combinedAmerican').textContent = fmtAmerican(toAmerican(Number(combined)));

      // wire remove buttons
      el.querySelectorAll('[data-remove]').forEach(btn => {
        btn.addEventListener('click', e => {
          const i = Number(e.currentTarget.getAttribute('data-remove'));
          slip.splice(i, 1);
          renderSlip();
          renderValidation(); // update errors dynamically when removing
        });
      });
    }

    document.getElementById('clearSlip').addEventListener('click', () => {
      slip = [];
      renderSlip();
      renderValidation();
    });

    // ===== LEAGUE RULES =====
    async function loadLeagueRules() {
      const rulesEl = document.getElementById('rules');
      try {
        const res = await fetch(`/league/${leagueId}`);
        const league = await res.json();
        if (!res.ok) throw new Error(league?.error || 'Failed to load league');

        leagueSettings = league.settings || {};
        const { numLegs, minLegOdds, minTotalOdds, leagueType } = leagueSettings;

        rulesEl.innerHTML = `
          <div><strong>Rules</strong></div>
          <div>Format: <strong>${leagueType}</strong></div>
          <div>Required legs: <strong>${numLegs}</strong></div>
          <div>Min leg odds: <strong>${minLegOdds > 0 ? '+' + minLegOdds : minLegOdds}</strong></div>
          <div>Min total parlay odds: <strong>+${minTotalOdds}</strong></div>
        `;
      } catch (e) {
        console.error('League rules error:', e);
        rulesEl.innerHTML = '<span class="warn">Could not load league rules. Submission will be blocked.</span>';
      }
    }

    function renderValidation() {
      const box = document.getElementById('validationErrors');
      if (!leagueSettings) { box.style.display = 'none'; box.innerHTML = ''; return; }

      const msgs = [];
      const { numLegs, minLegOdds, minTotalOdds } = leagueSettings;

      // 1) legs count — EXACT match (change to >= if you want “at least”)
      if (Number.isFinite(numLegs) && slip.length !== Number(numLegs)) {
        msgs.push(`Your parlay must have exactly ${numLegs} leg(s). You currently have ${slip.length}.`);
      }

      // 2) each leg meets minLegOdds (American)
      if (Number.isFinite(minLegOdds)) {
        const badLegs = slip
          .map((l, i) => ({ i, am: Number(l.oddsAmerican), label: `${l.team} ${fmtAmerican(l.oddsAmerican)}` }))
          .filter(x => !(x.am >= Number(minLegOdds))); // e.g., -160 >= -150 is false => invalid
        if (badLegs.length) {
          msgs.push(`The following leg(s) are below the minimum leg odds (${minLegOdds > 0 ? '+'+minLegOdds : minLegOdds}): ${badLegs.map(b => b.label).join(', ')}`);
        }
      }

      // 3) total meets minTotalOdds (compare in DECIMAL for correctness)
      if (Number.isFinite(minTotalOdds)) {
        const combinedDecimal = slip.reduce((acc, l) => acc * (l.priceDecimal || 1), 1);
        const minTotalDecimal = americanToDecimal(Number(minTotalOdds));
        if (combinedDecimal < minTotalDecimal) {
          const combinedAm = toAmerican(combinedDecimal);
          msgs.push(`Your total parlay odds ${fmtAmerican(combinedAm)} are below the minimum required +${minTotalOdds}. Add stronger legs or more plus-money.`);
        }
      }

      if (msgs.length) {
        box.style.display = '';
        box.innerHTML = `<div class="warn"><strong>Fix these before submitting:</strong></div><ul style="margin:8px 0 0 16px">${msgs.map(m => `<li>${m}</li>`).join('')}</ul>`;
      } else {
        box.style.display = 'none';
        box.innerHTML = '';
      }

      return msgs;
    }

    // ===== FETCH NFL ODDS =====
    async function loadNFL() {
      const container = document.getElementById('odds-container');
      try {
        const res = await fetch('/api/odds?sport=americanfootball_nfl');
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = '<div class="muted">No NFL odds available.</div>';
          return;
        }

        container.innerHTML = '';
        data.forEach(game => {
          const div = document.createElement('div');
          div.className = 'game';

          const home = game?.home_team || 'Home';
          const away = game?.away_team || 'Away';
          const commence = game?.commence_time ? new Date(game.commence_time).toLocaleString() : 'TBD';

          div.innerHTML = `
            <div class="row">
              <div>
                <div><strong>${away}</strong> @ <strong>${home}</strong></div>
                <div class="muted">${commence}</div>
              </div>
              <div class="muted">Game ID: ${game.id || 'n/a'}</div>
            </div>
            <div class="hr"></div>
            <div class="markets"></div>
          `;

          const book = (game.bookmakers && game.bookmakers[0]) || null;
          const marketsEl = div.querySelector('.markets');

          if (!book || !Array.isArray(book.markets)) {
            marketsEl.innerHTML = '<div class="muted">No markets available for this game.</div>';
          } else {
            const mIndex = {};
            book.markets.forEach(m => { mIndex[m.key] = m; });

            // Moneyline
            if (mIndex.h2h && Array.isArray(mIndex.h2h.outcomes)) {
              const ml = document.createElement('div');
              ml.innerHTML = `<div style="margin:6px 0"><strong>${book.title}</strong> • Moneyline</div>`;
              mIndex.h2h.outcomes.forEach(oc => {
                const price = Number(oc.price);
                const am = toAmerican(price);
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.textContent = `${oc.name} ${fmtAmerican(am)}`;
                btn.addEventListener('click', () => {
                  slip.push({
                    gameId: game.id, market: 'moneyline', side: oc.name,
                    team: oc.name, priceDecimal: price, oddsAmerican: am, book: book.title
                  });
                  renderSlip();
                  renderValidation();
                });
                ml.appendChild(btn);
              });
              marketsEl.appendChild(ml);
            }

            // Spread
            if (mIndex.spreads && Array.isArray(mIndex.spreads.outcomes)) {
              const sp = document.createElement('div');
              sp.innerHTML = `<div style="margin:6px 0"><strong>${book.title}</strong> • Spread</div>`;
              mIndex.spreads.outcomes.forEach(oc => {
                const price = Number(oc.price);
                const am = toAmerican(price);
                const line = oc.point;
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.textContent = `${oc.name} ${line > 0 ? '+'+line : line} ${fmtAmerican(am)}`;
                btn.addEventListener('click', () => {
                  slip.push({
                    gameId: game.id, market: 'spread', side: oc.name,
                    team: oc.name, line, priceDecimal: price, oddsAmerican: am, book: book.title
                  });
                  renderSlip();
                  renderValidation();
                });
                sp.appendChild(btn);
              });
              marketsEl.appendChild(sp);
            }

            // Totals
            if (mIndex.totals && Array.isArray(mIndex.totals.outcomes)) {
              const tot = document.createElement('div');
              tot.innerHTML = `<div style="margin:6px 0"><strong>${book.title}</strong> • Total</div>`;
              mIndex.totals.outcomes.forEach(oc => {
                const price = Number(oc.price);
                const am = toAmerican(price);
                const line = oc.point;
                const label = oc.name?.toUpperCase() || 'TOTAL';
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.textContent = `${label} ${line} ${fmtAmerican(am)}`;
                btn.addEventListener('click', () => {
                  slip.push({
                    gameId: game.id, market: 'total', side: label,
                    team: label, line, priceDecimal: price, oddsAmerican: am, book: book.title
                  });
                  renderSlip();
                  renderValidation();
                });
                tot.appendChild(btn);
              });
              marketsEl.appendChild(tot);
            }
          }

          container.appendChild(div);
        });
      } catch (e) {
        console.error(e);
        container.innerHTML = '<div class="danger">Failed to load NFL odds.</div>';
      }
    }

    // ===== SUBMIT PARLAY (with validation) =====
    function validateSlip() {
      if (!leagueSettings) return ['League rules not loaded. Please wait and try again.'];
      const errs = [];
      const { numLegs, minLegOdds, minTotalOdds } = leagueSettings;

      // count
      if (Number.isFinite(numLegs) && slip.length !== Number(numLegs)) {
        errs.push(`Your parlay must have exactly ${numLegs} leg(s). You currently have ${slip.length}.`);
      }
      // leg floor
      if (Number.isFinite(minLegOdds)) {
        const bad = slip.filter(l => Number(l.oddsAmerican) < Number(minLegOdds));
        if (bad.length) {
          errs.push(`At least one leg is below the minimum leg odds (${minLegOdds > 0 ? '+'+minLegOdds : minLegOdds}).`);
        }
      }
      // total floor (compare in decimal for correctness)
      if (Number.isFinite(minTotalOdds)) {
        const combinedDecimal = slip.reduce((acc, l) => acc * (l.priceDecimal || 1), 1);
        const minTotalDecimal = americanToDecimal(Number(minTotalOdds));
        if (combinedDecimal < minTotalDecimal) {
          const combinedAm = toAmerican(combinedDecimal);
          errs.push(`Your total parlay odds ${fmtAmerican(combinedAm)} are below the minimum required +${minTotalOdds}.`);
        }
      }
      return errs;
    }

    async function submitParlay() {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Please log in to submit a parlay.');
        return;
      }
      if (!leagueId || !week) {
        alert('Missing league or week.');
        return;
      }
      if (slip.length === 0) {
        alert('Add at least one leg.');
        return;
      }

      // validate against league rules
      const errs = validateSlip();
      const errBox = document.getElementById('validationErrors');
      if (errs.length) {
        errBox.style.display = '';
        errBox.innerHTML = `<div class="warn"><strong>Fix these before submitting:</strong></div><ul style="margin:8px 0 0 16px">${errs.map(e => `<li>${e}</li>`).join('')}</ul>`;
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return;
      } else {
        errBox.style.display = 'none';
        errBox.innerHTML = '';
      }

      // Build the picks payload expected by your backend
      const picks = slip.map(l => ({
        team: l.team,
        type: l.market,
        odds: l.oddsAmerican
      }));
      const totalOdds = slip.reduce((acc, l) => acc * (l.priceDecimal || 1), 1);

      try {
        const res = await fetch('/api/parlay/submit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ leagueId, week, picks, odds: Number(totalOdds.toFixed(4)) })
        });
        const data = await res.json();
        if (!res.ok) {
          console.error('Submit error:', data);
          alert(data.error || 'Error submitting parlay.');
          return;
        }
        alert('Parlay submitted!');
        location.href = `league_home.html?leagueId=${encodeURIComponent(leagueId)}`;
      } catch (err) {
        console.error(err);
        alert('Network/server error submitting parlay.');
      }
    }

    document.getElementById('submitParlay').addEventListener('click', submitParlay);

    // Init
    (async function init() {
      await loadLeagueRules();  // get rules first so we can validate live
      loadNFL();
      renderSlip();
      renderValidation();
    })();
  </script>
</body>
</html>

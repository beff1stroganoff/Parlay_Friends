<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>League Home | Parlay Friends</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Only add a disabled state; do NOT change your dark theme */
    button[disabled], .btn-submit[disabled], .button[disabled] {
      opacity: .5;
      cursor: not-allowed;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <header>
    <img src="Images/Parlay_Friends_Logo_Vectorized.svg" class="logo" alt="Parlay Friends Logo">
    <nav>
      <a href="dashboard.html" class="button">Back to Dashboard</a>
    </nav>
  </header>

  <main>
    <h1>üèà Welcome to <span id="leagueName">Your League</span>!</h1>

    <section class="line-item">
      <h2>League Details</h2>
      <div id="leagueDetails"></div>

      <div class="center mt-4">
        <button id="makePicksBtn" class="btn-submit">Make picks for this week</button>
      </div>

      <div class="center mt-4">
        <button id="edit-settings">Edit League Settings</button>
      </div>
    </section>

    <section class="line-item">
      <h3>Standings</h3>
      <label for="week-selector">Week #:</label>
      <input type="number" id="week-selector" min="1" value="1" />
      <button id="load-week">Load Week</button>
      <div id="viewLockHint" class="muted" style="display:none">Locked until you submit your parlay for this week.</div>

      <div id="standings-results" class="mt-4"></div>
    </section>

    <div id="season-stats" class="mt-4"></div>
  </main>

  <footer>
    <p>&copy; 2025 Parlay Friends. All rights reserved.</p>
  </footer>

  <script>
    // --- URL/context ---
    const params = new URLSearchParams(window.location.search);
    const leagueId = params.get('leagueId');
    if (!leagueId) {
      alert('No league ID found! Redirecting to dashboard...');
      window.location.href = 'dashboard.html';
    }

    // --- Helpers ---
    function getCurrentNFLWeek() {
      // Update each season (2025 opener: Thu Sep 4, 2025 ET)
      const seasonStart = new Date('2025-09-04T00:00:00-04:00');
      const msPerWeek = 7 * 24 * 60 * 60 * 1000;
      const diff = Date.now() - seasonStart.getTime();
      return Math.max(1, Math.ceil(diff / msPerWeek));
    }
    // Decimal -> American
    function americanFromDecimal(decimal) {
      const d = Number(decimal);
      if (!isFinite(d) || d <= 1) return -10000;
      return d >= 2 ? Math.round((d - 1) * 100) : Math.round(-100 / (d - 1));
    }
    function fmtAmerican(n) { return n > 0 ? `+${n}` : `${n}`; }

    // --- League header/details (PUBLIC: no auth header to avoid JWT logs) ---
    async function loadLeague() {
      try {
        const response = await fetch(`/league/${leagueId}`);
        const league = await response.json();
        if (response.ok) {
          document.getElementById('leagueName').textContent = league.name;
          document.getElementById('leagueDetails').innerHTML = `
            <strong>League Type:</strong> ${league.settings.leagueType}<br>
            <strong>Minimum Total Odds:</strong> +${league.settings.minTotalOdds}<br>
            <strong>Minimum Leg Odds:</strong> ${league.settings.minLegOdds}<br>
            <strong>Number of Legs:</strong> ${league.settings.numLegs}<br>
            <strong>Submission Deadline:</strong> ${league.settings.submissionDeadline}
          `;
        } else {
          document.getElementById('leagueDetails').textContent =
            league.error || 'Failed to load league details.';
        }
      } catch (err) {
        console.error('Error loading league:', err);
        document.getElementById('leagueDetails').textContent =
          'Server error loading league details.';
      }
    }

    // --- Gatekeeping: enable "Load Week" only after MY submission for that week ---
    async function checkMySubmissionAndToggle() {
      const btn = document.getElementById('load-week');
      const hint = document.getElementById('viewLockHint');
      const weekSel = document.getElementById('week-selector');
      if (!btn || !weekSel) return;

      const week = parseInt(weekSel.value, 10);
      btn.disabled = true;               // default: locked
      if (hint) hint.style.display = 'block';

      try {
        const token = localStorage.getItem('token');
        if (!token) return;              // keep locked if not logged in
        const res = await fetch(
          `/api/parlay/mine/${encodeURIComponent(leagueId)}/${encodeURIComponent(week)}`,
          { headers: { 'Authorization': 'Bearer ' + token } }
        );
        const data = await res.json().catch(() => ({}));
        const ok = !!data?.submitted;
        btn.disabled = !ok;
        if (hint) hint.style.display = ok ? 'none' : 'block';
      } catch (_) {
        // keep locked on error
      }
    }

    // --- Weekly picks/standings (AUTH: server enforces gating) ---
    async function loadWeekPicks() {
      const weekSel = document.getElementById('week-selector');
      const container = document.getElementById('standings-results');
      const week = parseInt(weekSel?.value, 10);

      if (!leagueId || !week) {
        alert('Missing league ID or week.');
        return;
      }

      try {
        const res = await fetch(
          `/api/parlay/week/${encodeURIComponent(leagueId)}/${encodeURIComponent(week)}`,
          { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') } }
        );

        if (res.status === 403) {
          document.getElementById('viewLockHint').style.display = 'block';
          alert('Submit your parlay for this week to view others.');
          return;
        }

        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = '<p class="center">No parlays submitted for this week.</p>';
          return;
        }

        container.innerHTML = '';
        data.forEach(parlay => {
          const userDiv = document.createElement('div');
          userDiv.className = 'line-item';
          userDiv.innerHTML = `<strong>${parlay.userId?.username || 'User'}</strong><br>`;

          // Individual legs (pick.odds already American per submit flow)
         // Short labels for display
function shortLabel(type) {
  const t = String(type || '').toLowerCase();
  const m = {
    moneyline: 'ML',
    spread: 'SPREAD',
    total: 'TOTAL',
    player_pass_yds: 'PASS YDS',
    player_rush_yds: 'RUSH YDS',
    player_reception_yds: 'REC YDS',
    player_anytime_td: 'ANYTIME TD',
    player_1st_td: '1ST TD'
  };
  return m[t] || t.toUpperCase();
}
function isNum(v){ return v !== '' && v !== null && v !== undefined && Number.isFinite(Number(v)); }

(parlay.picks || []).forEach(pick => {
  const type = String(pick.type || '').toLowerCase();
  const label = shortLabel(type);
  const oddsFmt = Number(pick.odds) > 0 ? '+' + pick.odds : String(pick.odds);

  const sideStr = String(pick.side || '');
  const isOver  = /^over$/i.test(sideStr);
  const isUnder = /^under$/i.test(sideStr);
  const ouTag   = isOver ? 'O' : (isUnder ? 'U' : '');

  const showLineFor = new Set(['total','player_pass_yds','player_rush_yds','player_reception_yds']);
  const lineTxt = (showLineFor.has(type) && isNum(pick.line)) ? ` ${Number(pick.line)}` : '';

  // subject text:
  //  - totals: "TOTAL"
  //  - player props: player name (stored in pick.team)
  //  - ML/Spread: team name
  const subject = type === 'total' ? 'TOTAL' : (pick.team || '');

  // build the parentheses text
  let paren = '(' + (type === 'total' ? '' : label);
if (ouTag) paren += (type === 'total' ? ouTag : ' ' + ouTag);
if (lineTxt) paren += (type === 'total' && ouTag ? ' ' : '') + lineTxt;
paren += ')';


  // For TD markets there is no O/U or line ‚Äî paren already just "(ANYTIME TD)" / "(1ST TD)"
  userDiv.innerHTML += `‚Ä¢ ${subject} ${paren} @ ${oddsFmt}<br>`;
});





          // Total odds (stored decimal) -> American
          const totalAm = fmtAmerican(americanFromDecimal(parlay.odds));
          userDiv.innerHTML += `<em>Total Odds: ${totalAm}</em><hr>`;
          container.appendChild(userDiv);
        });
      } catch (err) {
        console.error('Failed to fetch standings:', err);
        container.innerHTML = '<p class="center">Error loading picks.</p>';
      }
    }

    // --- Season stats (PUBLIC: no auth header to avoid JWT logs) ---
    async function loadSeasonStats() {
      const container = document.getElementById('season-stats');
      if (!leagueId || !container) return;

      try {
        const res = await fetch(`/api/league/${leagueId}/stats`);
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = '<p class="center">No stats yet.</p>';
          return;
        }

        const rows = data.map(s =>
          `<tr>
            <td>${s.username}</td>
            <td class="center">${s.legsWon}</td>
            <td class="center">${s.legsLost}</td>
            <td class="center">${s.parlayWins}</td>
            <td class="center">${s.parlayLosses}</td>
            <td class="center"><strong>${s.points}</strong></td>
          </tr>`
        ).join('');

        container.innerHTML = `
          <h3>Season Stats</h3>
          <div class="line-item">
            <table style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left;">Member</th>
                  <th>Legs Won</th>
                  <th>Legs Lost</th>
                  <th>Parlay Wins</th>
                  <th>Parlay Losses</th>
                  <th>Points</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      } catch (err) {
        console.error('Stats load error:', err);
        container.innerHTML = '<p class="center">Error loading stats.</p>';
      }
    }

    // --- Wire up ---
    document.addEventListener('DOMContentLoaded', () => {
      // Edit settings
      document.getElementById('edit-settings')?.addEventListener('click', () => {
        window.location.href = `league_settings.html?leagueId=${leagueId}`;
      });

      // Make picks for CURRENT week
      const makePicksBtn = document.getElementById('makePicksBtn');
      if (makePicksBtn) {
        const token = localStorage.getItem('token');
        if (!token) {
          makePicksBtn.disabled = true;
          makePicksBtn.title = 'Please log in';
        } else {
          makePicksBtn.addEventListener('click', () => {
            const wk = getCurrentNFLWeek();
            window.location.href = `lines.html?leagueId=${encodeURIComponent(leagueId)}&week=${encodeURIComponent(wk)}`;
          });
        }
      }

      // Preselect current week if missing/invalid
      const weekSel = document.getElementById('week-selector');
      if (weekSel && (!weekSel.value || Number(weekSel.value) < 1)) {
        weekSel.value = String(getCurrentNFLWeek());
      }

      // Lock/Unlock Load button based on my submission
      checkMySubmissionAndToggle();
      weekSel?.addEventListener('input', checkMySubmissionAndToggle);
      weekSel?.addEventListener('change', checkMySubmissionAndToggle);

      // Load weekly parlays on click
      document.getElementById('load-week')?.addEventListener('click', loadWeekPicks);

      // Load header + stats (public)
      loadLeague();
      loadSeasonStats();
    });
  </script>
</body>
</html>
